- hosts: registryservices[0]
  vars_files:
    - /home/deploy/quobyte-ansible/vars/ansible-vars
  become: yes
  tasks:
    - name: Get Quobyte session 
      shell:
        cmd: qmgmt -u {{ api_service }} user login {{ admin_user }} {{ admin_password }} 

    - name: See if Quobyte user exists 
      shell:
        cmd: qmgmt -u {{ api_service }} user config list| grep "^johnd" | awk '{print $1}'
      register: my_user_test

    - name: Create io500 user 
      shell:
        cmd: qmgmt -u {{ api_service }} user config add --admin-of-tenant=io500 --member-of-tenant=io500 --primary-group=johnd johnd john@doe.org UNPRIVILEGED_USER "johndoeDoesNotRememberThisPassword" 
      when: "'johnd' not in my_user_test.stdout"

    - name: See if accesskey for user exists 
      shell:
        cmd: qmgmt -u {{ api_service }} accesskey list| grep "^johnd" | awk '{print $1}'
      register: my_user_test

    - name: Create user access key pair
      shell:
        cmd: qmgmt -u {{ api_service }} accesskey create --tenant=io500 GENERAL_ACCESS_KEY johnd 
      when: "'johnd' not in my_user_test.stdout"

    - name: Get accesskey id 
      shell:
        cmd: qmgmt -u {{ api_service }} accesskey list| grep "^johnd" | awk '{print $2}'
      register: my_user_ak_id

    - name: Get accesskey secret 
      shell:
        cmd: qmgmt -u {{ api_service }} accesskey list| grep "^johnd" | awk '{print $3}'
      register: my_user_ak_secret

    - set_fact: 
        cacheable: true
        accesskey_id: "{{ my_user_ak_id.stdout }}"
    - set_fact: 
        cacheable: true
        accesskey_secret: "{{ my_user_ak_secret.stdout }}"

    - name: Print return information from the previous task
      ansible.builtin.debug:
       msg: "{{ ansible_facts['accesskey_id'] }}"

    - name: Configure systemd override 
      template:
        src: templates/client_systemd_orverride.jinja2
        dest: "/tmp/override.conf"

- hosts: localhost,clients 
  gather_facts: true
  vars_files:
    - /home/deploy/quobyte-ansible/vars/ansible-vars
  become: yes
  tasks:
    - name: Add the user 'johnd'
      ansible.builtin.user:
        name: johnd
        comment: John Doe

    - name: Enable "multi-tenant" in client service cfg. 
      template:
        src: templates/client-service.cfg.jinja2
        dest: "/etc/quobyte/client-service.cfg"

    - name: Create systemd override dir 
      ignore_errors: yes
      file:
        path: /etc/systemd/system/quobyte-client.service.d/
        state: directory

    - name: Configure systemd override 
      template:
        src: /tmp/override.conf 
        dest: "/etc/systemd/system/quobyte-client.service.d/override.conf"

    - name: Enable Quobyte client service
      service:
        enabled: true
        daemon_reload: true
        state: restarted
        name: "{{ item }}"
      with_items: 
         - quobyte-client

